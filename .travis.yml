sudo: false

addons:
  apt:
    packages:
      - google-chrome-stable
      - ocl-icd-opencl-dev

language: java

jdk:
  - openjdk8

env:
  - CHROMEDRIVER_BINARY=~/chromedriver
  - JDK=openjdk8
  - JDK=openjdk11
  - JDK=openjdk12

cache:
  directories:
    - $HOME/.m2
    - $HOME/cache/pip

python:
  - 2.7

before_install:
  - pip install --user codecov
  - wget -N http://chromedriver.storage.googleapis.com/2.34/chromedriver_linux64.zip -P ~/
  - unzip ~/chromedriver_linux64.zip -d ~/
  - rm ~/chromedriver_linux64.zip
  - sudo chmod +x ~/chromedriver
  - whereis google-chrome-stable
  - whereis chromedriver
  - jdk_switcher use $JDK

script:
  - mvn clean install -P jvmtestsonly

jobs:
  include:
    - stage: "Compiler Target Tests"
      env:
        - CHROMEDRIVER_BINARY=~/chromedriver
        - JDK=openjdk8
      script: mvn -pl '!:bytecoder-integrationtest' test -P jstestsonly
    - script: mvn -pl '!:bytecoder-integrationtest' test -P jstestsonly
      env:
        - CHROMEDRIVER_BINARY=~/chromedriver
        - JDK=openjdk11
    - script: mvn -pl '!:bytecoder-integrationtest' test -P jstestsonly
      env:
        - CHROMEDRIVER_BINARY=~/chromedriver
        - JDK=openjdk12
    - script: mvn -pl '!:bytecoder-integrationtest' test -P wasmtestsonly
      env:
        - CHROMEDRIVER_BINARY=~/chromedriver
        - JDK=openjdk8
    - script: mvn -pl '!:bytecoder-integrationtest' test -P wasmtestsonly
      env:
        - CHROMEDRIVER_BINARY=~/chromedriver
        - JDK=openjdk11
    - script: mvn -pl '!:bytecoder-integrationtest' test -P wasmtestsonly
      env:
        - CHROMEDRIVER_BINARY=~/chromedriver
        - JDK=openjdk112

after_success:
  - codecov
