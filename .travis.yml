sudo: false

addons:
  apt:
    packages:
      - google-chrome-stable
      - ocl-icd-opencl-dev

language: java

jdk:
  - openjdk8
  - openjdk11
  - openjdk12

env:
  global:
    - CHROMEDRIVER_BINARY=~/chromedriver

cache:
  directories:
    - $HOME/.m2
    - $HOME/.cache/install-jdk

before_install:
  - wget -N http://chromedriver.storage.googleapis.com/2.34/chromedriver_linux64.zip -P ~/
  - unzip ~/chromedriver_linux64.zip -d ~/
  - rm ~/chromedriver_linux64.zip
  - sudo chmod +x ~/chromedriver
  - whereis google-chrome-stable
  - whereis chromedriver
  - wget -N https://github.com/sormuras/bach/raw/master/install-jdk.sh -P ~/
  - sudo chmod +x ~/install-jdk.sh
  - sudo chmod +x .travis/deploy.sh

install: true

script:
  - mvn clean install -P jvmtestsonly

jobs:
  include:
    - stage: "Compiler Target Tests"
      name: "JS Target OpenJDK 8"
      script: mvn -pl '!:bytecoder-integrationtest' test -P jstestsonly
    - script: ~/install-jdk.sh -W /home/travis/openjdk11 -F 11 -L GPL && mvn -pl '!:bytecoder-integrationtest' test -P jstestsonly
      name: "JS Target OpenJDK 11"
    - script: ~/install-jdk.sh -W /home/travis/openjdk12 -F 12 -L GPL && mvn -pl '!:bytecoder-integrationtest' test -P jstestsonly
      name: "JS Target OpenJDK 12"
    - script: mvn -pl '!:bytecoder-integrationtest' test -P wasmtestsonly
      name: "WASM Target OpenJDK 8"
    - script: ~/install-jdk.sh -W /home/travis/openjdk11 -F 11 -L GPL && mvn -pl '!:bytecoder-integrationtest' test -P wasmtestsonly
      name: "WASM Target OpenJDK 11"
    - script: ~/install-jdk.sh -W /home/travis/openjdk12 -F 12 -L GPL && mvn -pl '!:bytecoder-integrationtest' test -P wasmtestsonly
      name: "WASM Target OpenJDK 12"
    - stage: "Deploy to Maven Central"
      script: skip
      deploy:
        - provider: script
          script: bash .travis/deploy.sh
          skip_cleanup: true
          on:
            repo: mirkosertic/Bytecoder
            branch: master
            jdk: openjdk8
        - provider: script
          script: .travis/deploy.sh
          skip_cleanup: true
          on:
            repo: mirkosertic/Bytecoder
            tags: true
            jdk: openjdk8